<!DOCTYPE html>
<html>
<head>
    <title>Manage Memories</title>
    {% load static %}
    <style>
        .memory-item {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .memory-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-bottom: 5px;
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        #upload-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Manage Memories</h1>

    <!-- Add URL as data attribute -->
    <div id="urls" 
         data-manage-memories-url="{% url 'manage_memories' %}"
         data-csrf-token="{{ csrf_token }}">
    </div>

    <div id="upload-section">
        <label for="image-upload">Upload Image:</label>
        <input type="file" id="image-upload" accept="image/*">
        <button onclick="uploadImage()">Upload</button>
    </div>

    <h2>Uploaded Memories:</h2>
    <ul id="memory-list">
        {% for memory in memories %}
            <li id="memory-{{ memory.id }}" class="memory-item">
                <img src="{{ memory.image.url }}" alt="Memory" class="memory-image">
                <button class="delete-btn" onclick="deleteImage({{ memory.id }})">Delete</button>
            </li>
        {% endfor %}
    </ul>

    <script>
        // Get URLs from data attributes
        const MANAGE_MEMORIES_URL = document.getElementById('urls').dataset.manageMemoriesUrl;
        const CSRF_TOKEN = document.getElementById('urls').dataset.csrfToken;

        async function uploadImage() {
            const imageInput = document.getElementById('image-upload');
            const image = imageInput.files[0];

            if (!image) {
                alert('Please select an image to upload.');
                return;
            }

            const formData = new FormData();
            formData.append('image', image);

            try {
                const response = await fetch(MANAGE_MEMORIES_URL, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    const newImage = createMemoryElement(data);
                    document.getElementById('memory-list').insertAdjacentHTML('beforeend', newImage);
                    imageInput.value = ''; // Clear the input
                    alert(data.message);
                    checkUploadLimit();
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
            } catch (error) {
                alert('An error occurred while uploading the image.');
                console.error('Upload error:', error);
            }
        }

        async function deleteImage(memoryId) {
            if (!confirm('Are you sure you want to delete this memory?')) {
                return;
            }

            try {
                const response = await fetch(`${MANAGE_MEMORIES_URL}?memory_id=${memoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN,
                    },
                });

                if (response.ok) {
                    document.getElementById(`memory-${memoryId}`).remove();
                    alert('Memory deleted successfully.');
                    checkUploadLimit();
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
            } catch (error) {
                alert('An error occurred while deleting the image.');
                console.error('Delete error:', error);
            }
        }

        function createMemoryElement(data) {
            return `
                <li id="memory-${data.memory_id}" class="memory-item">
                    <img src="${data.image_url}" alt="Memory" class="memory-image">
                    <button class="delete-btn" onclick="deleteImage(${data.memory_id})">Delete</button>
                </li>
            `;
        }

        function checkUploadLimit() {
            const memoryCount = document.getElementById('memory-list').children.length;
            const uploadSection = document.getElementById('upload-section');
            uploadSection.style.display = memoryCount >= 5 ? 'none' : 'block';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkUploadLimit();
        });
    </script>
</body>
</html>